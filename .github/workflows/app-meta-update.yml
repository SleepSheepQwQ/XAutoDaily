name: Android CI (Modern Runner)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 11 & 17
        uses: actions/setup-java@v4
        with:
          java-version: |
            11
            17
          distribution: 'temurin'

      - name: ğŸ› ï¸ Setup Legacy Android Environment
        run: |
          # 1. ä¸´æ—¶ä½¿ç”¨ JDK 17 æ¥è¿è¡Œ SDK ç®¡ç†å·¥å…·
          export JAVA_HOME=$JAVA_HOME_17_X64
          
          # 2. å®‰è£… AGP 7.2.2 å–œæ¬¢çš„æ—§ç‰ˆ NDK (23.x)
          # ä½¿ç”¨ --sdk_root ç¡®ä¿è·¯å¾„ç¡®å®šæ€§
          echo "y" | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --install "ndk;23.1.7779620" --sdk_root=$ANDROID_SDK_ROOT
          
          # 3. åˆ‡æ¢å› JDK 11 è¿›è¡Œé¡¹ç›®é…ç½®
          export JAVA_HOME=$JAVA_HOME_11_X64
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          echo "ndk.dir=$ANDROID_SDK_ROOT/ndk/23.1.7779620" >> local.properties
          
          # 4. è§£å†³ :stub çš„å±æ€§åŒ¹é…é—®é¢˜
          echo "android.matchingFallbacks.allowDefault=true" >> gradle.properties

      - name: ğŸš€ Precision Build
        run: |
          chmod +x gradlew
          # å¼ºåˆ¶é”å®šè¿è¡Œæ—¶ Gradle ç‰ˆæœ¬ï¼Œä¸ç»™æœåŠ¡å™¨â€œåŠ æˆâ€çš„ç©ºé—´
          ./gradlew wrapper --gradle-version 7.2
          ./gradlew :app:assembleDebug --no-daemon --stacktrace
