name: Android CI (Stabilized & Cached)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  # é˜¶æ®µä¸€ï¼šæºç ä¸å­æ¨¡å—å®¡è®¡
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ğŸ” Verify Environment
        run: |
          echo "=== æ£€æŸ¥å…³é”®å­æ¨¡å— ==="
          if [ -s "stub/build.gradle.kts" ] || [ -s "stub/build.gradle" ]; then
            echo "âœ… å­æ¨¡å—æºç å·²å°±ç»ª"
          else
            echo "âŒ å­æ¨¡å—ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥ .gitmodules"
            exit 1
          fi

  # é˜¶æ®µäºŒï¼šå—æ§æ„å»ºä¸äº§ç‰©æå–
  build:
    needs: audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          # ğŸ’¡ ç²¾åï¼šå¼€å¯ Gradle ç¼“å­˜ï¼Œè®© GitHub è®°ä½ä¸‹è½½è¿‡çš„ NDK å’Œä¸­é—´äº§ç‰©
          cache: 'gradle'

      - name: ğŸ”’ Atomic Configuration (Zero-Trust)
        run: |
          # 1. ç‰©ç†é‡ç½®é…ç½®ï¼Œå½»åº•æœç»ç²˜è¿å’Œè„é…ç½®
          rm -f gradle.properties
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=true
          android.useAndroidX=true
          android.enableJetifier=true
          android.matchingFallbacks=debug,release
          android.experimental.enableNewResourceShrinker=false
          EOF

          # 2. ç‰©ç†é”å®š Gradle 7.3.3 (AGP 7.2.2 çš„æœ€ä½³æ‹æ¡£)
          sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-7.3.3-bin.zip|' gradle/wrapper/gradle-wrapper.properties
          
          # 3. æ³¨å…¥æœ¬åœ° SDK è·¯å¾„ç¯å¢ƒå˜é‡
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: ğŸš€ Execution (Assemble APK)
        run: |
          chmod +x gradlew
          # ä½¿ç”¨ --no-daemon ç¡®ä¿ç¯å¢ƒç»å¯¹çº¯å‡€
          ./gradlew :app:assembleDebug --no-daemon --stacktrace

      # ğŸ äº§ç‰©æå–ï¼šå°†ç”Ÿæˆçš„ APK ä¿å­˜åˆ° GitHub Actions é¡µé¢
      - name: ğŸ“¦ Upload APK Result
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: XAutoDaily-Debug-${{ github.run_id }}
          path: app/build/outputs/apk/debug/*.apk
          retention-days: 7
