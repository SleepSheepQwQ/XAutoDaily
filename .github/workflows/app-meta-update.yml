name: Android CI

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  # ä»»åŠ¡ä¸€ï¼šå®¡æŸ¥ç¨‹åº (å¿«é€Ÿé¢„æ£€ï¼Œé€šå¸¸åœ¨ 20s å†…å®Œæˆ)
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: ðŸ”Ž Project Structure Audit
        run: |
          echo "=== å¼€å§‹ç‰©ç†å®¡æŸ¥ ==="
          
          # 1. æ£€æŸ¥å­æ¨¡å—æºä»£ç æ˜¯å¦å­˜åœ¨
          modules=("stub" "mmkv" "dexkit")
          for mod in "${modules[@]}"; do
            if [ -f "$mod/build.gradle.kts" ] || [ -f "$mod/build.gradle" ]; then
              echo "âœ… æ¨¡å— $mod: å·²å‘çŽ°æž„å»ºè„šæœ¬"
            else
              echo "âŒ é”™è¯¯: æ¨¡å— $mod æºç ç¼ºå¤±ã€‚è¯·æ£€æŸ¥ .gitmodules æˆ–é€’å½’æ‹‰å–è®¾ç½®ã€‚"
              exit 1
            fi
          done

          # 2. æ£€æŸ¥å…³é”®ç›®å½•
          if [ ! -d "app/src/main" ]; then
            echo "âŒ é”™è¯¯: ä¸»æ¨¡å— app ç»“æž„å¼‚å¸¸ã€‚"
            exit 1
          fi
          
          echo "=== å®¡æŸ¥é€šè¿‡ ==="

  # ä»»åŠ¡äºŒï¼šæ­£å¼æž„å»º (ä¾èµ–äºŽ audit ä»»åŠ¡)
  build:
    needs: audit  # åªæœ‰ audit æˆåŠŸï¼Œæ‰ä¼šæ‰§è¡Œ build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Initialize Environment
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          # è‡ªåŠ¨å¯»æ‰¾ NDK è·¯å¾„
          NDK_PATH=$(ls -d $ANDROID_SDK_ROOT/ndk/* | head -n 1)
          echo "ndk.dir=$NDK_PATH" >> local.properties
          echo "android.matchingFallbacks.allowDefault=true" >> gradle.properties

      - name: Build APK
        run: |
          chmod +x gradlew
          ./gradlew :app:assembleDebug --no-daemon --stacktrace

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: XAutoDaily-Build
          path: app/build/outputs/apk/debug/*.apk
