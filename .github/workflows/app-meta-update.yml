name: Android CI (Stabilized)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  # ä»»åŠ¡ä¸€ï¼šæ·±åº¦å®¡è®¡
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: ðŸ”Ž Deep Audit
        run: |
          echo "=== ç‰©ç†å®¡è®¡ ==="
          # éªŒè¯å­æ¨¡å—ä¸ä»…æœ‰æ–‡ä»¶å¤¹ï¼Œè¿˜å¾—æœ‰å…·ä½“å¤§å°çš„è„šæœ¬æ–‡ä»¶
          if [ -s "stub/build.gradle.kts" ] || [ -s "stub/build.gradle" ]; then
            echo "âœ… Submodule 'stub' is valid."
          else
            echo "âŒ Submodule 'stub' is empty or missing build script."
            exit 1
          fi

  # ä»»åŠ¡äºŒï¼šå—æŽ§æž„å»º
  build:
    needs: audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: ðŸ”’ Atomic Configuration (Zero-Trust Mode)
        run: |
          # 1. ç‰©ç†ç§»é™¤æ‰€æœ‰å¯èƒ½å¹²æ‰°çš„å±žæ€§
          rm -f gradle.properties
          
          # 2. é‡æ–°æž„å»ºå¹²å‡€çš„ gradle.properties (ä½¿ç”¨å•å¼•å· 'EOF' é˜²æ­¢å˜é‡æ³„éœ²)
          cat > gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          android.useAndroidX=true
          android.enableJetifier=true
          android.matchingFallbacks=debug,release
          # å…³é”®ï¼šç¦ç”¨æ‰€æœ‰å¯èƒ½å¯¼è‡´ 7.5.1 å´©æºƒçš„å®žéªŒæ€§åŠŸèƒ½
          android.experimental.enableNewResourceShrinker=false
          android.defaults.buildfeatures.buildconfig=true
          EOF

          # 3. å¼ºåˆ¶é”å®š Gradle 7.3.3 (AGP 7.2.2 çš„æœ€ä½³æ‹æ¡£)
          sed -i 's|distributionUrl=.*|distributionUrl=https\://services.gradle.org/distributions/gradle-7.3.3-bin.zip|' gradle/wrapper/gradle-wrapper.properties
          
          # 4. å¼ºåˆ¶ç‰©ç†é‡ç½®å­æ¨¡å— (æœ€åŽä¸€é“é˜²çº¿)
          git submodule update --init --recursive --force

      - name: ðŸš€ Execution
        run: |
          chmod +x gradlew
          # ä½¿ç”¨ --no-daemon ç¡®ä¿çŽ¯å¢ƒç»å¯¹éš”ç¦»
          ./gradlew :app:assembleDebug --no-daemon --stacktrace
