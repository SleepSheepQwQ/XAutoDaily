name: Android CI (Self-Diagnostic Edition)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: ğŸ› ï¸ Diagnostic: System Environment Check
        # ç¬¬ä¸€æ­¥è‡ªæ£€ï¼šçœ‹çœ‹ GitHub åˆ°åº•ç»™äº†æˆ‘ä»¬ä»€ä¹ˆç¯å¢ƒ
        run: |
          echo "=== æ ¸å¿ƒç¯å¢ƒè‡ªæ£€ ==="
          java -version
          echo "Android Home: $ANDROID_SDK_ROOT"
          echo "NDK Bundle: /usr/local/lib/android/sdk/ndk-bundle"
          ls /usr/local/lib/android/sdk/ndk || echo "NDK dir not found"
          
      - name: Initialize Project Properties
        run: |
          echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
          # åŠ¨æ€å¯»æ‰¾ NDK è·¯å¾„ï¼Œé˜²æ­¢ç¡¬ç¼–ç å¤±æ•ˆ
          NDK_PATH=$(ls -d /usr/local/lib/android/sdk/ndk/* | head -n 1 || echo "/usr/local/lib/android/sdk/ndk-bundle")
          echo "ndk.dir=$NDK_PATH" >> local.properties
          echo "android.matchingFallbacks.allowDefault=true" >> gradle.properties
          echo "Using NDK path: $NDK_PATH"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: '7.2'

      - name: ğŸš€ Build APK with Self-Diagnostic
        run: |
          chmod +x gradlew
          # ä½¿ç”¨ --continue å³ä½¿å­æ¨¡å—å¤±è´¥ä¹Ÿå°è¯•æš´éœ²æ›´å¤šé”™è¯¯ä¿¡æ¯
          # ä½¿ç”¨ -P å¼ºåˆ¶è¦†ç›–å¯èƒ½å†²çªçš„é…ç½®
          ./gradlew :app:assembleDebug --no-daemon --stacktrace --continue \
            -Dorg.gradle.debug=false \
            -Dorg.gradle.daemon=false \
            -Pandroid.uniquePackageNames=false

      - name: ğŸ” Post-Failure Diagnostic
        # åªæœ‰åœ¨ä¸Šé¢æ­¥éª¤å¤±è´¥æ—¶æ‰ä¼šè¿è¡Œ
        if: failure()
        run: |
          echo "=== ç¼–è¯‘å¤±è´¥è¯Šæ–­æŠ¥å‘Š ==="
          echo "1. æ£€æŸ¥å­æ¨¡å—ç›®å½•æ˜¯å¦å­˜åœ¨å†…å®¹:"
          ls -R stub | head -n 20
          echo "2. è¾“å‡ºè¯¦ç»†ä¾èµ–å…³ç³»å›¾ (æŸ¥æ‰¾å†²çª):"
          ./gradlew :app:dependencies --configuration debugCompileClasspath || echo "Failed to get dependencies"
          echo "3. æœç´¢æœ€è¿‘çš„ Error æ—¥å¿—è®°å½•:"
          # å¯»æ‰¾å…·ä½“çš„ Kotlin/Java æŠ¥é”™è¡Œ
          find . -name "build" -type d -prune -o -name "*.kt" -print | xargs grep -l "class" | head -n 5

      - name: Upload Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: XAutoDaily-Build
          path: app/build/outputs/apk/debug/*.apk
